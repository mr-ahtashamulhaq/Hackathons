<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Feedback Lite</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>Feedback Lite - Admin Panel</h1>
            <nav class="nav">
                <a href="/submit">Submit Feedback</a>
                <a href="/admin">Admin Panel</a>
                <button onclick="logout()" class="btn btn-secondary" style="margin-left: 20px; padding: 8px 16px;">
                    ðŸ”“ Logout
                </button>
            </nav>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Feedback Management</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary btn-sm" onclick="generateInsights()">
                        ðŸ§  Generate Insights
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="loadFeedback()">
                        ðŸ”„ Refresh
                    </button>
                </div>
            </div>
            
            <div id="alert-container"></div>
            
            <!-- AI Insights Section -->
            <div id="insights-container" style="display: none; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">ðŸ“Š AI Insights</h3>
                <div id="insights-loading" class="loading" style="display: none;">
                    Generating insights...
                </div>
                <div id="insights-content" style="display: none;">
                    <div id="insights-summary" style="background: #e3f2fd; border: 1px solid #bbdefb; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                        <!-- Summary will be populated here -->
                    </div>
                    <div id="insights-clusters">
                        <!-- Clusters will be populated here -->
                    </div>
                </div>
            </div>
            
            <div id="stats-container" style="margin-bottom: 20px;"></div>
            
            <div id="loading" class="loading" style="display: none;">
                Loading feedback...
            </div>
            
            <div class="table-container">
                <table class="table" id="feedback-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Text Preview</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="feedback-tbody">
                    </tbody>
                </table>
            </div>
            
            <div id="no-feedback" style="display: none; text-align: center; padding: 40px; color: #666;">
                <h3>No feedback yet</h3>
                <p>No feedback has been submitted yet. Check back later!</p>
                <a href="/submit" class="btn btn-primary">Submit First Feedback</a>
            </div>
        </div>
    </div>

    <!-- Modal for viewing feedback details -->
    <div id="modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Feedback Details</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            
            <div id="modal-content">
                <!-- Content will be loaded here -->
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                <button class="btn btn-primary" id="toggle-status-btn" onclick="toggleStatus()">
                    Toggle Status
                </button>
            </div>
        </div>
    </div>

    <script>
        let feedbackData = [];
        let currentFeedbackId = null;

        // Load feedback on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadFeedback();
        });

        async function loadFeedback() {
            const loading = document.getElementById('loading');
            const table = document.getElementById('feedback-table');
            const noFeedback = document.getElementById('no-feedback');
            const alertContainer = document.getElementById('alert-container');
            
            loading.style.display = 'block';
            table.style.display = 'none';
            noFeedback.style.display = 'none';
            alertContainer.innerHTML = '';
            
            try {
                const response = await fetch('/api/feedback');
                const data = await response.json();
                
                if (data.success) {
                    feedbackData = data.data;
                    
                    if (feedbackData.length === 0) {
                        noFeedback.style.display = 'block';
                    } else {
                        renderFeedbackTable(feedbackData);
                        table.style.display = 'table';
                    }
                    
                    updateStats(feedbackData);
                } else {
                    showAlert('Failed to load feedback: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error loading feedback:', error);
                showAlert('Network error. Please check your connection.', 'error');
            } finally {
                loading.style.display = 'none';
            }
        }

        function renderFeedbackTable(feedback) {
            const tbody = document.getElementById('feedback-tbody');
            tbody.innerHTML = '';
            
            feedback.forEach(item => {
                const row = document.createElement('tr');
                const textPreview = item.text.length > 60 ? 
                    item.text.substring(0, 60) + '...' : 
                    item.text;
                
                const formattedDate = new Date(item.created_at).toLocaleString();
                
                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${escapeHtml(textPreview)}</td>
                    <td>${formattedDate}</td>
                    <td>
                        <span class="status-badge status-${item.status}">${item.status}</span>
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="viewFeedback(${item.id})">
                            View
                        </button>
                        <button class="btn btn-sm ${item.status === 'new' ? 'btn-success' : 'btn-secondary'}" 
                                onclick="quickToggleStatus(${item.id}, '${item.status === 'new' ? 'resolved' : 'new'}')">
                            ${item.status === 'new' ? 'Resolve' : 'Reopen'}
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateStats(feedback) {
            const statsContainer = document.getElementById('stats-container');
            const newCount = feedback.filter(f => f.status === 'new').length;
            const resolvedCount = feedback.filter(f => f.status === 'resolved').length;
            const totalCount = feedback.length;
            
            statsContainer.innerHTML = `
                <div style="display: flex; gap: 20px; margin-bottom: 10px;">
                    <div style="background: #fff3cd; padding: 10px; border-radius: 6px; flex: 1; text-align: center;">
                        <strong>${newCount}</strong><br>
                        <small>New</small>
                    </div>
                    <div style="background: #d1ecf1; padding: 10px; border-radius: 6px; flex: 1; text-align: center;">
                        <strong>${resolvedCount}</strong><br>
                        <small>Resolved</small>
                    </div>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; flex: 1; text-align: center;">
                        <strong>${totalCount}</strong><br>
                        <small>Total</small>
                    </div>
                </div>
            `;
        }

        async function viewFeedback(id) {
            const modal = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            
            try {
                const response = await fetch(`/api/feedback/${id}`);
                const data = await response.json();
                
                if (data.success) {
                    const feedback = data.data;
                    currentFeedbackId = id;
                    
                    const formattedDate = new Date(feedback.created_at).toLocaleString();
                    
                    content.innerHTML = `
                        <div style="margin-bottom: 15px;">
                            <strong>ID:</strong> ${feedback.id}
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>Date:</strong> ${formattedDate}
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>Status:</strong> 
                            <span class="status-badge status-${feedback.status}">${feedback.status}</span>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>Feedback:</strong>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-top: 5px; white-space: pre-wrap;">${escapeHtml(feedback.text)}</div>
                        </div>
                    `;
                    
                    // Update toggle button
                    const toggleBtn = document.getElementById('toggle-status-btn');
                    toggleBtn.textContent = feedback.status === 'new' ? 'Mark as Resolved' : 'Mark as New';
                    
                    modal.style.display = 'flex';
                } else {
                    showAlert('Failed to load feedback details.', 'error');
                }
            } catch (error) {
                console.error('Error loading feedback details:', error);
                showAlert('Failed to load feedback details.', 'error');
            }
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
            currentFeedbackId = null;
        }

        async function toggleStatus() {
            if (!currentFeedbackId) return;
            
            const currentFeedback = feedbackData.find(f => f.id === currentFeedbackId);
            if (!currentFeedback) return;
            
            const newStatus = currentFeedback.status === 'new' ? 'resolved' : 'new';
            
            try {
                const response = await fetch(`/api/feedback/${currentFeedbackId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert(`Feedback marked as ${newStatus}.`, 'success');
                    closeModal();
                    loadFeedback(); // Reload the table
                } else {
                    showAlert('Failed to update status: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error updating status:', error);
                showAlert('Failed to update status.', 'error');
            }
        }

        async function quickToggleStatus(id, newStatus) {
            try {
                const response = await fetch(`/api/feedback/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert(`Feedback marked as ${newStatus}.`, 'success');
                    loadFeedback(); // Reload the table
                } else {
                    showAlert('Failed to update status: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error updating status:', error);
                showAlert('Failed to update status.', 'error');
            }
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            
            alertContainer.innerHTML = `
                <div class="alert ${alertClass}">
                    ${message}
                </div>
            `;
            
            if (type === 'success') {
                setTimeout(() => {
                    alertContainer.innerHTML = '';
                }, 3000);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Logout function
        async function logout() {
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Logged out successfully. Redirecting...', 'success');
                    // Redirect to login page after short delay
                    setTimeout(() => {
                        window.location.href = '/admin/login';
                    }, 1000);
                } else {
                    showAlert('Failed to logout: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Logout error:', error);
                showAlert('Failed to logout. Please try again.', 'error');
            }
        }

        // Generate Insights functionality
        async function generateInsights() {
            const insightsContainer = document.getElementById('insights-container');
            const insightsLoading = document.getElementById('insights-loading');
            const insightsContent = document.getElementById('insights-content');
            const alertContainer = document.getElementById('alert-container');
            
            // Show insights section and loading state
            insightsContainer.style.display = 'block';
            insightsLoading.style.display = 'block';
            insightsContent.style.display = 'none';
            alertContainer.innerHTML = '';
            
            try {
                const response = await fetch('/api/insights');
                const data = await response.json();
                
                if (data.success) {
                    renderInsights(data.data);
                    insightsContent.style.display = 'block';
                    showAlert('Insights generated successfully!', 'success');
                } else {
                    showAlert('Failed to generate insights: ' + (data.error || 'Unknown error'), 'error');
                    insightsContainer.style.display = 'none';
                }
            } catch (error) {
                console.error('Error generating insights:', error);
                showAlert('Failed to generate insights. Please try again.', 'error');
                insightsContainer.style.display = 'none';
            } finally {
                insightsLoading.style.display = 'none';
            }
        }
        
        function renderInsights(insights) {
            const summaryDiv = document.getElementById('insights-summary');
            const clustersDiv = document.getElementById('insights-clusters');
            
            // Render summary
            summaryDiv.innerHTML = `
                <h4 style="margin: 0 0 10px 0; color: #1976d2;">ðŸ“‹ Summary</h4>
                <p style="margin: 0; line-height: 1.5;">${escapeHtml(insights.summary)}</p>
            `;
            
            // Render clusters
            if (insights.clusters && insights.clusters.length > 0) {
                clustersDiv.innerHTML = `
                    <h4 style="margin: 0 0 15px 0; color: #1976d2;">ðŸŽ¯ Feedback Themes</h4>
                    ${insights.clusters.map(cluster => `
                        <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <h5 style="margin: 0 0 10px 0; color: #495057;">${escapeHtml(cluster.title)}</h5>
                            <div style="margin-left: 15px;">
                                ${cluster.examples.map(example => `
                                    <div style="background: #fff; border-left: 3px solid #007bff; padding: 8px 12px; margin-bottom: 8px; font-style: italic; color: #666;">
                                        "${escapeHtml(example.length > 120 ? example.substring(0, 120) + '...' : example)}"
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                `;
            } else {
                clustersDiv.innerHTML = `
                    <h4 style="margin: 0 0 15px 0; color: #1976d2;">ðŸŽ¯ Feedback Themes</h4>
                    <p style="color: #666; font-style: italic;">No specific themes identified in the current feedback.</p>
                `;
            }
        }

        // Close modal when clicking outside
        document.getElementById('modal-overlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>
</body>
</html>